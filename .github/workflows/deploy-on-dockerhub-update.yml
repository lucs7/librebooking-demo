name: Deploy on Docker Hub image update

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch:

jobs:
  check-and-deploy:
    name: Check Docker image digest and deploy if updated
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-group
      cancel-in-progress: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download last deployed digest artifact (if it exists)
        uses: actions/download-artifact@v4
        with:
          name: last-deployed-digest
        continue-on-error: true

      - name: Get current Docker image digest
        id: get_digest
        run: |
          IMAGE="librebooking/librebooking"
          TAG="develop"

          # Get digest from Docker Hub
          DIGEST=$(curl -s "https://registry.hub.docker.com/v2/repositories/${IMAGE}/tags/${TAG}" | jq -r '.images[0].digest')

          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "$DIGEST" > current-digest.txt

      - name: Compare with previous digest
        id: compare
        run: |
          echo "Previous digest:"
          cat last-deployed-digest.txt || echo "none"

          echo "Current digest:"
          cat current-digest.txt

          if cmp -s current-digest.txt last-deployed-digest.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          mv current-digest.txt last-deployed-digest.txt
        continue-on-error: true

      - name: Setup Fly.io CLI
        if: steps.compare.outputs.changed == 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        if: steps.compare.outputs.changed == 'true'
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Upload current digest as artifact
        if: steps.compare.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: last-deployed-digest
          path: last-deployed-digest.txt
          retention-days: 90

      - name: Echo deploy summary
        if: steps.compare.outputs.changed == 'true'
        run: |
          echo "âœ… Deployed image with digest: ${{ steps.get_digest.outputs.digest }}"