name: Deploy on Docker Hub image update

on:
  schedule:
    - cron: "0 */2 * * *" # Every 2 hours
  workflow_dispatch:

jobs:
  check-and-deploy:
    name: Check Docker image digest and deploy if updated
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-group
      cancel-in-progress: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image variables
        id: vars
        run: |
          echo "IMAGE=librebooking/librebooking" >> $GITHUB_OUTPUT
          echo "TAG=develop" >> $GITHUB_OUTPUT

      - name: Get current Docker Hub digest
        id: dockerhub
        run: |
          DIGEST=$(docker manifest inspect ${{ steps.vars.outputs.IMAGE }}:${{ steps.vars.outputs.TAG }} | jq -r '.config.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Current Docker Hub digest: $DIGEST"

      - name: Download previous digest
        id: download
        uses: actions/download-artifact@v4
        with:
          name: docker-digest
          path: .
        continue-on-error: true

      - name: Compare digests
        id: compare
        run: |
          if [ -f digest.txt ]; then
            PREVIOUS_DIGEST=$(cat digest.txt)
            echo "Previous digest: $PREVIOUS_DIGEST"
            echo "Current digest: ${{ steps.dockerhub.outputs.digest }}"
            
            if [ "$PREVIOUS_DIGEST" != "${{ steps.dockerhub.outputs.digest }}" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Image has been updated!"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ No changes detected"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• First run, will deploy"
          fi

      - name: Setup Fly.io CLI
        if: steps.compare.outputs.changed == 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        if: steps.compare.outputs.changed == 'true'
        run: flyctl deploy --remote-only --no-cache --recreate-builder
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Save current digest
        if: steps.compare.outputs.changed == 'true'
        run: echo "${{ steps.dockerhub.outputs.digest }}" > digest.txt

      - name: Upload digest artifact
        if: steps.compare.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docker-digest
          path: digest.txt
          retention-days: 90